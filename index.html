<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Midwest Escape 1998</title>
<style>
body{margin:0;overflow:hidden;background:#000;}
#ui{
 position:absolute;
 top:10px;
 left:10px;
 color:white;
 font-family:sans-serif;
}
#staminaBar{
 width:200px;height:20px;background:#333;margin-top:5px;
}
#stamina{height:100%;width:100%;background:lime;}
</style>
</head>
<body>

<div id="ui">
WASD移動 / Shiftダッシュ / F振り向き
<div id="staminaBar"><div id="stamina"></div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script>

//////////////////////////////////////////////////
// 基本
//////////////////////////////////////////////////

const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87a8c4); // 夜明け前ブルー

const camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,1000);
camera.position.set(0,1.7,0);

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.shadowMap.enabled=true;
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff,0.6));

const sun=new THREE.DirectionalLight(0xffddaa,1);
sun.position.set(50,100,50);
sun.castShadow=true;
scene.add(sun);

//////////////////////////////////////////////////
// 地面（アスファルト風）
//////////////////////////////////////////////////

const ground=new THREE.Mesh(
 new THREE.PlaneGeometry(300,300),
 new THREE.MeshStandardMaterial({color:0x444444})
);
ground.rotation.x=-Math.PI/2;
ground.receiveShadow=true;
scene.add(ground);

//////////////////////////////////////////////////
// 郊外住宅
//////////////////////////////////////////////////

const buildingBoxes=[];

function createHouse(x,z){

 if(Math.sqrt(x*x+z*z)<10) return; // 安全エリア

 const house=new THREE.Group();

 // 本体
 const body=new THREE.Mesh(
   new THREE.BoxGeometry(4,3,4),
   new THREE.MeshStandardMaterial({color:0xc2b280}) // ベージュ
 );
 body.position.y=1.5;
 body.castShadow=true;
 house.add(body);

 // 屋根
 const roof=new THREE.Mesh(
   new THREE.ConeGeometry(3.5,2,4),
   new THREE.MeshStandardMaterial({color:0x8b0000})
 );
 roof.position.y=3.5;
 roof.rotation.y=Math.PI/4;
 roof.castShadow=true;
 house.add(roof);

 // ドア
 const door=new THREE.Mesh(
   new THREE.BoxGeometry(1,2,0.1),
   new THREE.MeshStandardMaterial({color:0x552200})
 );
 door.position.set(0,1,-2.05);
 house.add(door);

 // 窓
 const windowGeo=new THREE.BoxGeometry(0.8,0.8,0.1);
 const windowMat=new THREE.MeshStandardMaterial({color:0x99ccff, emissive:0x222244});
 const w1=new THREE.Mesh(windowGeo,windowMat);
 w1.position.set(-1,1,2.05);
 house.add(w1);

 const w2=new THREE.Mesh(windowGeo,windowMat);
 w2.position.set(1,1,2.05);
 house.add(w2);

 house.position.set(x,0,z);
 scene.add(house);

 const box=new THREE.Box3().setFromObject(body);
 buildingBoxes.push(box);
}

// 密集住宅地
for(let x=-40;x<=40;x+=8){
 for(let z=-40;z<=40;z+=8){
   if(Math.random()>0.15) createHouse(x,z);
 }
}

//////////////////////////////////////////////////
// ビルエリア
//////////////////////////////////////////////////

for(let i=0;i<6;i++){
 const building=new THREE.Mesh(
   new THREE.BoxGeometry(8,20,8),
   new THREE.MeshStandardMaterial({color:0x555577})
 );
 building.position.set(
   (Math.random()-0.5)*80,
   10,
   -80 + Math.random()*20
 );
 building.castShadow=true;
 scene.add(building);
}

//////////////////////////////////////////////////
// 敵（クリーチャー化）
//////////////////////////////////////////////////

const enemy=new THREE.Group();

// 下半身
const legs=new THREE.Mesh(
 new THREE.CylinderGeometry(0.6,0.6,2),
 new THREE.MeshStandardMaterial({color:0x552222})
);
legs.position.y=1;
enemy.add(legs);

// 胴体
const torso=new THREE.Mesh(
 new THREE.BoxGeometry(2,2.5,1.5),
 new THREE.MeshStandardMaterial({color:0x773333})
);
torso.position.y=3;
enemy.add(torso);

// 頭
const head=new THREE.Mesh(
 new THREE.SphereGeometry(1),
 new THREE.MeshStandardMaterial({color:0xaa4444})
);
head.position.y=5;
enemy.add(head);

// 目
const eyeGeo=new THREE.SphereGeometry(0.2);
const eyeMat=new THREE.MeshBasicMaterial({color:0xffffff});
const eye1=new THREE.Mesh(eyeGeo,eyeMat);
eye1.position.set(-0.4,5.2,0.8);
enemy.add(eye1);

const eye2=new THREE.Mesh(eyeGeo,eyeMat);
eye2.position.set(0.4,5.2,0.8);
enemy.add(eye2);

// 口
const mouth=new THREE.Mesh(
 new THREE.BoxGeometry(0.8,0.2,0.1),
 new THREE.MeshBasicMaterial({color:0x000000})
);
mouth.position.set(0,4.6,0.9);
enemy.add(mouth);

enemy.position.set(-20,0,-20);
scene.add(enemy);

//////////////////////////////////////////////////
// 操作
//////////////////////////////////////////////////

const keys={};
document.addEventListener("keydown",e=>{
 const k=e.key.toLowerCase();
 keys[k]=true;
 if(k==="f") yaw+=Math.PI;
});
document.addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

document.body.addEventListener("click",()=>{
 document.body.requestPointerLock();
});

let pitch=0,yaw=0,targetPitch=0,targetYaw=0;

document.addEventListener("mousemove",e=>{
 if(document.pointerLockElement===document.body){
   targetYaw-=e.movementX*0.0015;
   targetPitch-=e.movementY*0.0015;
   targetPitch=Math.max(-Math.PI/3,Math.min(Math.PI/3,targetPitch));
 }
});

//////////////////////////////////////////////////
// スタミナ
//////////////////////////////////////////////////

let stamina=100;
const staminaEl=document.getElementById("stamina");

//////////////////////////////////////////////////
// 移動
//////////////////////////////////////////////////

function move(){
 let speed=0.15;
 if(keys["shift"]&&stamina>0){
   speed=0.3;
   stamina-=0.6;
 }else stamina+=0.3;

 stamina=Math.max(0,Math.min(100,stamina));
 staminaEl.style.width=stamina+"%";
 staminaEl.style.background=stamina<30?"red":"lime";

 const dir=new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
 const right=new THREE.Vector3(-dir.z,0,dir.x);

 let moveVec=new THREE.Vector3();
 if(keys["w"]) moveVec.add(dir);
 if(keys["s"]) moveVec.sub(dir);
 if(keys["a"]) moveVec.sub(right);
 if(keys["d"]) moveVec.add(right);

 if(moveVec.length()>0){
   moveVec.normalize().multiplyScalar(speed);
   camera.position.x+=moveVec.x;
   camera.position.z+=moveVec.z;
 }

 camera.position.y=1.7;
}

//////////////////////////////////////////////////
// 敵追跡
//////////////////////////////////////////////////

function updateEnemy(){
 const dx=camera.position.x-enemy.position.x;
 const dz=camera.position.z-enemy.position.z;
 const dist=Math.sqrt(dx*dx+dz*dz);

 if(dist>2){
   enemy.position.x+=dx/dist*0.05;
   enemy.position.z+=dz/dist*0.05;
 }

 enemy.lookAt(camera.position);
}

//////////////////////////////////////////////////
// アニメーション
//////////////////////////////////////////////////

function animate(){
 requestAnimationFrame(animate);

 yaw+=(targetYaw-yaw)*0.15;
 pitch+=(targetPitch-pitch)*0.15;
 camera.rotation.set(pitch,yaw,0);

 move();
 updateEnemy();

 renderer.render(scene,camera);
}
animate();

</script>
</body>
</html>
