<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Katamari Deluxe</title>
<style>
body{margin:0;overflow:hidden;background:black;}
#menu{
position:absolute;
top:50%;left:50%;
transform:translate(-50%,-50%);
color:white;
font-family:sans-serif;
text-align:center;
}
button{padding:10px 20px;margin:5px;font-size:16px;}
#ui{
position:absolute;
top:10px;left:10px;
color:white;
font-family:sans-serif;
display:none;
}
</style>
</head>
<body>

<div id="menu">
<h1>ステージ選択</h1>
<button onclick="startGame('house')">イエ</button>
<button onclick="startGame('city')">マチ</button>
<button onclick="startGame('world')">セカイ</button>
<button onclick="startGame('space')">ウチュウ</button>
</div>

<div id="ui">
サイズ: <span id="size">10</span>cm |
目標: <span id="goal"></span> |
残り: <span id="time"></span>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>

<script>

let scene,camera,renderer,ball;
let size=10,radius;
let objects=[];
let timeLimit,goalSize;
let keys={};
let yaw=0,pitch=0;

//////////////////////////////////////////////////
// ステージ開始
//////////////////////////////////////////////////

function startGame(type){

 document.getElementById("menu").style.display="none";
 document.getElementById("ui").style.display="block";

 if(type==="house"){goalSize=150;timeLimit=120;}
 if(type==="city"){goalSize=400;timeLimit=150;}
 if(type==="world"){goalSize=800;timeLimit=180;}
 if(type==="space"){goalSize=1500;timeLimit=220;}

 document.getElementById("goal").innerText=goalSize+"cm";

 init(type);
 startTimer();
}

//////////////////////////////////////////////////
// 初期化
//////////////////////////////////////////////////

function init(stage){

 scene=new THREE.Scene();

 camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,5000);

 renderer=new THREE.WebGLRenderer({antialias:true});
 renderer.setSize(innerWidth,innerHeight);
 renderer.shadowMap.enabled=true;
 document.body.appendChild(renderer.domElement);

 // 空
 const skyGeo=new THREE.SphereGeometry(4000,32,32);
 const skyMat=new THREE.MeshBasicMaterial({
  color:stage==="space"?0x000011:0x87CEEB,
  side:THREE.BackSide
 });
 const sky=new THREE.Mesh(skyGeo,skyMat);
 scene.add(sky);

 // 雲（space以外）
 if(stage!=="space"){
  for(let i=0;i<20;i++){
   const cloud=new THREE.Mesh(
    new THREE.SphereGeometry(20,8,8),
    new THREE.MeshBasicMaterial({color:0xffffff})
   );
   cloud.position.set(
    (Math.random()-0.5)*2000,
    200+Math.random()*200,
    (Math.random()-0.5)*2000
   );
   scene.add(cloud);
  }
 }

 // 光
 const light=new THREE.DirectionalLight(0xffffff,1);
 light.position.set(200,400,200);
 light.castShadow=true;
 scene.add(light);
 scene.add(new THREE.AmbientLight(0xffffff,0.4));

 // 地面
 const ground=new THREE.Mesh(
  new THREE.PlaneGeometry(3000,3000),
  new THREE.MeshStandardMaterial({
   color:stage==="space"?0x333333:0x4caf50
  })
 );
 ground.rotation.x=-Math.PI/2;
 ground.receiveShadow=true;
 scene.add(ground);

 // ボール
 size=10;
 radius=size/10;

 const tex=new THREE.TextureLoader().load(
  "https://threejs.org/examples/textures/planets/jupiter.jpg"
 );

 ball=new THREE.Mesh(
  new THREE.SphereGeometry(radius,32,32),
  new THREE.MeshStandardMaterial({map:tex})
 );
 ball.castShadow=true;
 ball.position.y=radius;
 scene.add(ball);

 createStageObjects(stage);

 document.body.addEventListener("click",()=>{
  document.body.requestPointerLock();
 });

 document.addEventListener("mousemove",e=>{
  if(document.pointerLockElement===document.body){
   yaw-=e.movementX*0.002;
   pitch-=e.movementY*0.002;
   pitch=Math.max(-1.2,Math.min(1.2,pitch));
  }
 });

 document.addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
 document.addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

 animate();
}

//////////////////////////////////////////////////
// ステージ別オブジェクト
//////////////////////////////////////////////////

function createStageObjects(stage){

 objects=[];

 let count=stage==="house"?200:
           stage==="city"?400:
           stage==="world"?600:800;

 for(let i=0;i<count;i++){

  let mesh;

  if(stage==="house"){
   mesh=new THREE.Mesh(
    new THREE.BoxGeometry(3,2,2),
    new THREE.MeshStandardMaterial({color:0xff4444})
   );
  }
  else if(stage==="city"){
   mesh=new THREE.Mesh(
    new THREE.BoxGeometry(10,20,10),
    new THREE.MeshStandardMaterial({color:0x888888})
   );
  }
  else if(stage==="world"){
   mesh=new THREE.Mesh(
    new THREE.SphereGeometry(10),
    new THREE.MeshStandardMaterial({color:0x228B22})
   );
  }
  else{
   mesh=new THREE.Mesh(
    new THREE.SphereGeometry(20),
    new THREE.MeshStandardMaterial({color:0x9999ff})
   );
  }

  mesh.position.set(
   (Math.random()-0.5)*2000,
   5,
   (Math.random()-0.5)*2000
  );

  mesh.castShadow=true;
  mesh.userData.size=Math.random()*50+5;
  mesh.userData.attached=false;

  scene.add(mesh);
  objects.push(mesh);
 }
}

//////////////////////////////////////////////////
// タイマー
//////////////////////////////////////////////////

function startTimer(){
 const t=setInterval(()=>{
  timeLimit--;
  document.getElementById("time").innerText=timeLimit+"s";
  if(timeLimit<=0){
   clearInterval(t);
   alert(size>=goalSize?"成功！":"失敗！");
   location.reload();
  }
 },1000);
}

//////////////////////////////////////////////////
// アニメーション
//////////////////////////////////////////////////

function animate(){
 requestAnimationFrame(animate);

 let speed=keys["shift"]?0.6:0.3;

 let move=new THREE.Vector3();

 if(keys["w"]) move.z-=1;
 if(keys["s"]) move.z+=1;
 if(keys["a"]) move.x-=1;
 if(keys["d"]) move.x+=1;

 if(move.length()>0){

  move.normalize().multiplyScalar(speed);

  ball.position.add(move);

  // 動いたときだけ回転
  ball.rotation.x+=move.z*0.2;
  ball.rotation.z-=move.x*0.2;
 }

 // 吸収
 for(let obj of objects){
  if(obj.userData.attached) continue;

  let dist=ball.position.distanceTo(obj.position);

  if(dist<radius+obj.userData.size*0.1){
   if(obj.userData.size<size*1.2){

    obj.userData.attached=true;

    let offset=obj.position.clone().sub(ball.position);
    ball.add(obj);
    obj.position.copy(offset);

    size+=obj.userData.size*0.1;
    radius=size/10;
    ball.scale.set(radius,radius,radius);
    ball.position.y=radius;

    document.getElementById("size").innerText=Math.floor(size);
   }
  }
 }

 // カメラ自由
 let camDist=radius*3+30;

 camera.position.set(
  ball.position.x+Math.sin(yaw)*camDist*Math.cos(pitch),
  ball.position.y+Math.sin(pitch)*camDist+10,
  ball.position.z+Math.cos(yaw)*camDist*Math.cos(pitch)
 );
 camera.lookAt(ball.position);

 renderer.render(scene,camera);
}

</script>
</body>
</html>
