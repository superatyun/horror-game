<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Midwest Escape 1998</title>
<style>
body { margin:0; overflow:hidden; background:black; cursor:crosshair; }
#ui{
position:absolute;
top:20px;
left:20px;
color:white;
font-family:monospace;
background:rgba(0,0,0,0.6);
padding:12px;
}
button{
margin-top:8px;
padding:6px 10px;
background:black;
color:white;
border:1px solid white;
cursor:pointer;
}
</style>
</head>
<body>

<div id="ui">
<div id="message">CLICK TO START – ESCAPE</div>
<button id="retry" style="display:none;">RETRY</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>

<script>

// ===== シーン =====
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x04040a);
scene.fog = new THREE.Fog(0x04040a, 20, 120);

// ===== カメラ =====
const camera = new THREE.PerspectiveCamera(
75,
window.innerWidth/window.innerHeight,
0.1,
1000
);
camera.position.set(0,5,10);

// ===== レンダラー =====
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// ===== ライト =====
const moon = new THREE.DirectionalLight(0x8899ff, 1.2);
moon.position.set(50,100,50);
scene.add(moon);

const ambient = new THREE.AmbientLight(0x303030,0.8);
scene.add(ambient);

// ===== 地面 =====
const roadGeo = new THREE.PlaneGeometry(400,400);
const roadMat = new THREE.MeshStandardMaterial({color:0x1a1a1a});
const road = new THREE.Mesh(roadGeo,roadMat);
road.rotation.x = -Math.PI/2;
scene.add(road);

// ===== 建物密集 =====
for(let z=-20; z>-200; z-=30){
for(let x=-40; x<=40; x+=40){
const houseGeo = new THREE.BoxGeometry(25,15,25);
const houseMat = new THREE.MeshStandardMaterial({color:0x2a2a3a});
const house = new THREE.Mesh(houseGeo,houseMat);
house.position.set(x,7.5,z);
scene.add(house);
}
}

// ===== プレイヤー（人型）=====
const player = new THREE.Group();

// 体
const body = new THREE.Mesh(
new THREE.CylinderGeometry(1,1,4,16),
new THREE.MeshStandardMaterial({color:0xcccccc})
);
body.position.y=2;
player.add(body);

// 頭
const head = new THREE.Mesh(
new THREE.SphereGeometry(1.2,16,16),
new THREE.MeshStandardMaterial({color:0xffe0bd})
);
head.position.y=4.5;
player.add(head);

player.position.set(0,0,0);
scene.add(player);

// ===== 敵（下半身だけ）=====
const enemy = new THREE.Group();

// 腰
const torso = new THREE.Mesh(
new THREE.CylinderGeometry(1.2,1.2,3,16),
new THREE.MeshStandardMaterial({color:0x220000})
);
torso.position.y=3;
enemy.add(torso);

// 足1
const leg1 = new THREE.Mesh(
new THREE.CylinderGeometry(0.5,0.5,4,12),
new THREE.MeshStandardMaterial({color:0x110000})
);
leg1.position.set(-0.5,1,0);
enemy.add(leg1);

// 足2
const leg2 = leg1.clone();
leg2.position.x=0.5;
enemy.add(leg2);

enemy.position.set(0,0,-60);
scene.add(enemy);

// ===== EXIT =====
const exitGeo = new THREE.BoxGeometry(10,6,2);
const exitMat = new THREE.MeshStandardMaterial({color:0x00ff00});
const exit = new THREE.Mesh(exitGeo,exitMat);
exit.position.set(0,4,-220);
scene.add(exit);

// ===== マウス視点制御 =====
let yaw=0;
let pitch=0;
let pointerLocked=false;

document.body.addEventListener("click",()=>{
renderer.domElement.requestPointerLock();
});

document.addEventListener("pointerlockchange",()=>{
pointerLocked=document.pointerLockElement===renderer.domElement;
});

document.addEventListener("mousemove",(e)=>{
if(pointerLocked){
yaw -= e.movementX * 0.002;
pitch -= e.movementY * 0.002;
pitch = Math.max(-1.5,Math.min(1.5,pitch));
}
});

// ===== 操作 =====
let keys={};
document.addEventListener("keydown",e=>keys[e.code]=true);
document.addEventListener("keyup",e=>keys[e.code]=false);

let gameOver=false;
let enemySpeed=0.05;

function resetGame(){
player.position.set(0,0,0);
enemy.position.set(0,0,-60);
enemySpeed=0.05;
gameOver=false;
document.getElementById("retry").style.display="none";
document.getElementById("message").innerText="ESCAPE";
}

document.getElementById("retry").onclick=resetGame;

// ===== ループ =====
function animate(){
requestAnimationFrame(animate);

if(!gameOver){

// 移動
let dirX=Math.sin(yaw);
let dirZ=Math.cos(yaw);

if(keys["KeyW"]){
player.position.x+=dirX*0.4;
player.position.z+=dirZ*0.4;
}
if(keys["KeyS"]){
player.position.x-=dirX*0.4;
player.position.z-=dirZ*0.4;
}
if(keys["KeyA"]){
player.position.x+=dirZ*0.4;
player.position.z-=dirX*0.4;
}
if(keys["KeyD"]){
player.position.x-=dirZ*0.4;
player.position.z+=dirX*0.4;
}

// カメラ
camera.position.set(
player.position.x,
player.position.y+6,
player.position.z
);

camera.rotation.order="YXZ";
camera.rotation.y=yaw;
camera.rotation.x=pitch;

// 敵追跡
let dx=player.position.x-enemy.position.x;
let dz=player.position.z-enemy.position.z;
let dist=Math.sqrt(dx*dx+dz*dz);

enemy.position.x+=dx/dist*enemySpeed;
enemy.position.z+=dz/dist*enemySpeed;
enemySpeed+=0.00005;

if(dist<4){
gameOver=true;
document.getElementById("message").innerText="YOU WERE CAUGHT";
document.getElementById("retry").style.display="block";
}

let exitDist=Math.sqrt(
(player.position.x-exit.position.x)**2+
(player.position.z-exit.position.z)**2
);

if(exitDist<8){
gameOver=true;
document.getElementById("message").innerText="YOU ESCAPED";
document.getElementById("retry").style.display="block";
}

}

renderer.render(scene,camera);
}

animate();

</script>
</body>
</html>
