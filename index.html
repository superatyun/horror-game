<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Evening Escape - Dense Suburb</title>
<style>
body{margin:0;overflow:hidden;background:#ff8844;}
#ui{
position:absolute;
top:10px;left:10px;
color:white;font-family:sans-serif;
}
</style>
</head>
<body>
<div id="ui">ã‚¯ãƒªãƒƒã‚¯ã§è¦–ç‚¹æ“ä½œ / WASDç§»å‹• / Shiftãƒ€ãƒƒã‚·ãƒ¥ / Fé•·æŠ¼ã—æŒ¯ã‚Šå‘ã</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script>

//////////////////////////////////////////////////
// åŸºæœ¬
//////////////////////////////////////////////////

const scene=new THREE.Scene();
scene.fog=new THREE.FogExp2(0xff8844,0.012);

const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.1,1500);
camera.position.set(0,1.7,0);

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.setClearColor(0xff8844);
document.body.appendChild(renderer.domElement);

//////////////////////////////////////////////////
// ãƒ©ã‚¤ãƒˆï¼ˆå¤•æ–¹ï¼‰
//////////////////////////////////////////////////

scene.add(new THREE.AmbientLight(0xffbb88,0.8));
const sun=new THREE.DirectionalLight(0xff9966,0.8);
sun.position.set(-100,80,50);
scene.add(sun);

//////////////////////////////////////////////////
// åœ°é¢
//////////////////////////////////////////////////

const ground=new THREE.Mesh(
 new THREE.PlaneGeometry(800,800),
 new THREE.MeshStandardMaterial({color:0x666666})
);
ground.rotation.x=-Math.PI/2;
scene.add(ground);

//////////////////////////////////////////////////
// è¡çªç®¡ç†
//////////////////////////////////////////////////

const colliders=[];
function addCollider(mesh){colliders.push(mesh);}

function collide(pos){
 const box=new THREE.Box3(
  new THREE.Vector3(pos.x-1,0,pos.z-1),
  new THREE.Vector3(pos.x+1,2,pos.z+1)
 );
 for(let m of colliders){
  const mbox=new THREE.Box3().setFromObject(m);
  if(box.intersectsBox(mbox)) return true;
 }
 return false;
}

//////////////////////////////////////////////////
// æ—¥æœ¬ã®å®¶ï¼ˆå¯†é›†ï¼‰
//////////////////////////////////////////////////

function createJapaneseHouse(x,z){

 const base=new THREE.Mesh(
  new THREE.BoxGeometry(7,6,7),
  new THREE.MeshStandardMaterial({color:0xe0e0e0})
 );
 base.position.set(x,3,z);
 scene.add(base);
 addCollider(base);

 const roof=new THREE.Mesh(
  new THREE.ConeGeometry(6,4,4),
  new THREE.MeshStandardMaterial({color:0x333333})
 );
 roof.position.set(x,7,z);
 roof.rotation.y=Math.PI/4;
 scene.add(roof);

 // å¡€ï¼ˆå°ã•ã‚ï¼‰
 const fence=new THREE.Mesh(
  new THREE.BoxGeometry(8.5,1.5,8.5),
  new THREE.MeshStandardMaterial({color:0x999999})
 );
 fence.position.set(x,0.75,z);
 scene.add(fence);
 addCollider(fence);

 // æ¤ç‰©
 if(Math.random()>0.5){
  const plant=new THREE.Mesh(
   new THREE.SphereGeometry(1.2,8,8),
   new THREE.MeshStandardMaterial({color:0x228833})
  );
  plant.position.set(x+3,1.2,z+3);
  scene.add(plant);
  addCollider(plant);
 }
}

//////////////////////////////////////////////////
// å…¬åœ’ï¼ˆãƒ©ãƒ³ãƒ€ãƒ ä½ç½®ï¼‰
//////////////////////////////////////////////////

function createPark(px,pz){

 // åœ°é¢
 const parkGround=new THREE.Mesh(
  new THREE.PlaneGeometry(40,40),
  new THREE.MeshStandardMaterial({color:0x3a7a3a})
 );
 parkGround.rotation.x=-Math.PI/2;
 parkGround.position.set(px,0.01,pz);
 scene.add(parkGround);

 // ãƒ–ãƒ©ãƒ³ã‚³é¢¨
 const swing=new THREE.Mesh(
  new THREE.BoxGeometry(6,5,1),
  new THREE.MeshStandardMaterial({color:0xaa0000})
 );
 swing.position.set(px,2.5,pz);
 scene.add(swing);
 addCollider(swing);

 // æœ¨
 for(let i=0;i<5;i++){
  const tree=new THREE.Mesh(
   new THREE.CylinderGeometry(0.5,0.7,5,8),
   new THREE.MeshStandardMaterial({color:0x5a3a1a})
  );
  tree.position.set(
   px+(Math.random()-0.5)*30,
   2.5,
   pz+(Math.random()-0.5)*30
  );
  scene.add(tree);
  addCollider(tree);
 }
}

// å…¬åœ’ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ
const parkX=(Math.random()-0.5)*400;
const parkZ=(Math.random()-0.5)*400;
createPark(parkX,parkZ);

//////////////////////////////////////////////////
// å®¶å¯†é›†ç”Ÿæˆ
//////////////////////////////////////////////////

for(let x=-350;x<=350;x+=10){
 for(let z=-350;z<=350;z+=10){
  if(Math.abs(x)<20 && Math.abs(z)<20) continue;
  if(Math.abs(x-parkX)<30 && Math.abs(z-parkZ)<30) continue;
  createJapaneseHouse(x,z);
 }
}

//////////////////////////////////////////////////
// æ•µï¼ˆè¿½è·¡é€Ÿåº¦UPï¼‰
//////////////////////////////////////////////////

const enemy=new THREE.Group();

const body=new THREE.Mesh(
 new THREE.CylinderGeometry(1,1.2,5,12),
 new THREE.MeshStandardMaterial({color:0x111111})
);
body.position.y=2.5;
enemy.add(body);

const head=new THREE.Mesh(
 new THREE.SphereGeometry(1,16,16),
 new THREE.MeshStandardMaterial({color:0xffffff})
);
head.position.y=5;
enemy.add(head);

enemy.position.set(-100,0,-100);
scene.add(enemy);
addCollider(enemy);

//////////////////////////////////////////////////
// ã‚«ãƒ¡ãƒ©æ“ä½œ
//////////////////////////////////////////////////

let yaw=0,pitch=0;
let lookingBack=false;

document.body.addEventListener("click",()=>{
 document.body.requestPointerLock();
});

document.addEventListener("mousemove",e=>{
 if(document.pointerLockElement===document.body){
  yaw-=e.movementX*0.002;
  pitch-=e.movementY*0.002;
  pitch=Math.max(-Math.PI/3,Math.min(Math.PI/3,pitch));
 }
});

//////////////////////////////////////////////////
// å…¥åŠ›
//////////////////////////////////////////////////

const keys={};

document.addEventListener("keydown",e=>{
 keys[e.key.toLowerCase()]=true;
 if(e.key.toLowerCase()==="f") lookingBack=true;
});

document.addEventListener("keyup",e=>{
 keys[e.key.toLowerCase()]=false;
 if(e.key.toLowerCase()==="f") lookingBack=false;
});

//////////////////////////////////////////////////
// ãƒªã‚¹ãƒãƒ¼ãƒ³
//////////////////////////////////////////////////

function resetGame(){
 camera.position.set(0,1.7,0);
 enemy.position.set(-100,0,-100);
}

//////////////////////////////////////////////////
// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
//////////////////////////////////////////////////

function animate(){
 requestAnimationFrame(animate);

 camera.rotation.order="YXZ";
 camera.rotation.y=lookingBack?yaw+Math.PI:yaw;
 camera.rotation.x=pitch;

 let speed=keys["shift"]?0.35:0.18;

 let forward=new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
 let right=new THREE.Vector3(-forward.z,0,forward.x);
 let move=new THREE.Vector3();

 if(keys["w"]) move.add(forward);
 if(keys["s"]) move.sub(forward);
 if(keys["a"]) move.sub(right);
 if(keys["d"]) move.add(right);

 if(move.length()>0){
  move.normalize().multiplyScalar(speed);
  let newPos=camera.position.clone().add(move);
  if(!collide(newPos)){
   camera.position.x=newPos.x;
   camera.position.z=newPos.z;
  }
 }

 camera.position.y=1.7;

 // ğŸ”¥ è¿½è·¡é€Ÿåº¦ã‚¢ãƒƒãƒ—
 let dx=camera.position.x-enemy.position.x;
 let dz=camera.position.z-enemy.position.z;
 let dist=Math.sqrt(dx*dx+dz*dz);

 if(dist>2){
  let step=new THREE.Vector3(dx/dist*0.12,0,dz/dist*0.12);
  let next=enemy.position.clone().add(step);
  if(!collide(next)){
   enemy.position.copy(next);
  }
 }

 if(dist<2){
  alert("ä¸å¯©è€…ã«æ•ã¾ã£ãŸâ€¦");
  resetGame();
 }

 enemy.lookAt(camera.position);

 renderer.render(scene,camera);
}
animate();

</script>
</body>
</html>
