<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Katamari Ultimate</title>
<style>
body{margin:0;overflow:hidden;background:black;font-family:sans-serif;}
#menu{
position:absolute;top:50%;left:50%;
transform:translate(-50%,-50%);
color:white;text-align:center;
}
button{padding:10px 20px;margin:5px;font-size:16px;}
#ui{
position:absolute;top:10px;left:10px;color:white;display:none;
}
</style>
</head>
<body>

<div id="menu">
<h1>ステージ選択</h1>
<button onclick="startGame('house')">イエ</button>
<button onclick="startGame('city')">マチ</button>
<button onclick="startGame('world')">セカイ</button>
<button onclick="startGame('earth')">チキュウ</button>
<button onclick="startGame('space')">ウチュウ</button>
</div>

<div id="ui">
サイズ: <span id="size">10</span>cm<br>
目標: <span id="goal"></span>cm<br>
残り時間: <span id="time"></span>s
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script>

let scene,camera,renderer,ball;
let objects=[],gates=[];
let size=10,radius;
let keys={};
let yaw=0,pitch=0;
let goal=500;
let timeLimit=120;
let timer;

function startGame(stage){
 document.getElementById("menu").style.display="none";
 document.getElementById("ui").style.display="block";
 init(stage);
}

function init(stage){

 scene=new THREE.Scene();
 camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,20000);

 renderer=new THREE.WebGLRenderer({antialias:true});
 renderer.setSize(innerWidth,innerHeight);
 renderer.shadowMap.enabled=true;
 document.body.appendChild(renderer.domElement);

 const light=new THREE.DirectionalLight(0xffffff,1);
 light.position.set(300,500,300);
 light.castShadow=true;
 scene.add(light);
 scene.add(new THREE.AmbientLight(0xffffff,0.4));

 size=10;
 radius=size/10;

 ball=new THREE.Mesh(
  new THREE.SphereGeometry(radius,32,32),
  new THREE.MeshStandardMaterial({color:0xff66cc})
 );
 ball.castShadow=true;
 ball.position.y=radius;
 scene.add(ball);

 createStage(stage);

 document.body.addEventListener("click",()=>{
  document.body.requestPointerLock();
 });

 document.addEventListener("mousemove",e=>{
  if(document.pointerLockElement===document.body){
   yaw-=e.movementX*0.002;
   pitch-=e.movementY*0.002;
   pitch=Math.max(-1.2,Math.min(1.2,pitch));
  }
 });

 document.addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
 document.addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

 goal = stage==="house"?200:
        stage==="city"?500:
        stage==="world"?1500:
        stage==="earth"?5000:20000;

 document.getElementById("goal").innerText=goal;

 timer=setInterval(()=>{
  timeLimit--;
  document.getElementById("time").innerText=timeLimit;
  if(timeLimit<=0){
   alert(size>=goal?"成功！":"失敗！");
   location.reload();
  }
 },1000);

 animate();
}

function createStage(stage){

 let groundSize=stage==="house"?200:
                stage==="city"?1000:
                stage==="world"?2000:
                stage==="earth"?4000:6000;

 const ground=new THREE.Mesh(
  new THREE.PlaneGeometry(groundSize,groundSize),
  new THREE.MeshStandardMaterial({color:stage==="house"?0xd2b48c:0x228b22})
 );
 ground.rotation.x=-Math.PI/2;
 ground.receiveShadow=true;
 scene.add(ground);

 for(let i=0;i<300;i++){
  let s=Math.random()*30+5;
  let geo=Math.random()>0.5?
   new THREE.BoxGeometry(s,s,s):
   new THREE.CylinderGeometry(s/2,s/2,s,8);

  let obj=new THREE.Mesh(
   geo,
   new THREE.MeshStandardMaterial({color:Math.random()*0xffffff})
  );
  obj.position.set(
   (Math.random()-0.5)*groundSize,
   s/2,
   (Math.random()-0.5)*groundSize
  );
  obj.castShadow=true;
  obj.userData.size=s;
  obj.userData.attached=false;
  scene.add(obj);
  objects.push(obj);
 }

 // サイズ制限ゲート
 let gate=new THREE.Mesh(
  new THREE.BoxGeometry(50,50,5),
  new THREE.MeshStandardMaterial({color:0xff0000})
 );
 gate.position.set(0,25,-groundSize/4);
 gate.userData.minSize=500;
 gate.userData.isGate=true;
 scene.add(gate);
 gates.push(gate);
}

function animate(){
 requestAnimationFrame(animate);

 let speed=keys["shift"]?0.8:0.4;

 let forward=new THREE.Vector3(
  Math.sin(yaw),0,Math.cos(yaw)
 );
 let right=new THREE.Vector3(
  Math.cos(yaw),0,-Math.sin(yaw)
 );

 let move=new THREE.Vector3();

 if(keys["w"]) move.add(forward);
 if(keys["s"]) move.sub(forward);
 if(keys["a"]) move.sub(right);
 if(keys["d"]) move.add(right);

 if(move.length()>0){
  move.normalize().multiplyScalar(speed);
  ball.position.add(move);

  ball.rotation.x+=move.z*0.2;
  ball.rotation.z-=move.x*0.2;
 }

 for(let obj of objects){
  if(obj.userData.attached) continue;

  let dist=ball.position.distanceTo(obj.position);
  let objR=obj.userData.size/10;

  if(dist<radius+objR){

   if(obj.userData.size<size*1.2){
    obj.userData.attached=true;
    let offset=obj.position.clone().sub(ball.position);
    ball.add(obj);
    obj.position.copy(offset);

    size+=obj.userData.size*0.1;
    radius=size/10;
    ball.scale.set(radius,radius,radius);
    ball.position.y=radius;
    document.getElementById("size").innerText=Math.floor(size);
   }
   else{
    let push=ball.position.clone().sub(obj.position).normalize();
    ball.position.add(push);
   }
  }
 }

 for(let gate of gates){
  if(size<gate.userData.minSize){
   if(ball.position.distanceTo(gate.position)<30){
    let push=ball.position.clone().sub(gate.position).normalize();
    ball.position.add(push.multiplyScalar(2));
   }
  }
 }

 let camDist=radius*4+30;

 camera.position.set(
  ball.position.x+Math.sin(yaw)*camDist*Math.cos(pitch),
  ball.position.y+camDist*Math.sin(pitch)+radius*2,
  ball.position.z+Math.cos(yaw)*camDist*Math.cos(pitch)
 );

 camera.lookAt(ball.position);

 renderer.render(scene,camera);
}

</script>
</body>
</html>
