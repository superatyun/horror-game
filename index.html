<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Mini Katamari</title>
<style>
body { margin:0; overflow:hidden; background:#87CEEB; }
#ui{
position:absolute;
top:10px; left:10px;
color:white;
font-family:sans-serif;
}
</style>
</head>
<body>
<div id="ui">WASD移動 / サイズ: <span id="size">1</span></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script>

////////////////////////////
// 基本設定
////////////////////////////

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x87CEEB);

const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0, 10, 15);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff, 0.8));
const light = new THREE.DirectionalLight(0xffffff, 0.8);
light.position.set(10,20,10);
scene.add(light);

////////////////////////////
// 地面
////////////////////////////

const ground = new THREE.Mesh(
 new THREE.PlaneGeometry(200,200),
 new THREE.MeshStandardMaterial({color:0x55aa55})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

////////////////////////////
// 塊
////////////////////////////

let size = 1;

const ballGeo = new THREE.SphereGeometry(size,32,32);
const ballMat = new THREE.MeshStandardMaterial({color:0xff69b4});
const ball = new THREE.Mesh(ballGeo, ballMat);
ball.position.y = size;
scene.add(ball);

////////////////////////////
// オブジェクト配置
////////////////////////////

const objects = [];

function createObject(){
 const scale = Math.random()*2 + 0.5;

 const obj = new THREE.Mesh(
  new THREE.BoxGeometry(scale,scale,scale),
  new THREE.MeshStandardMaterial({
   color: new THREE.Color(Math.random(),Math.random(),Math.random())
  })
 );

 obj.position.set(
  (Math.random()-0.5)*150,
  scale/2,
  (Math.random()-0.5)*150
 );

 obj.userData.size = scale;

 scene.add(obj);
 objects.push(obj);
}

for(let i=0;i<120;i++){
 createObject();
}

////////////////////////////
// 操作
////////////////////////////

const keys = {};
document.addEventListener("keydown", e=>keys[e.key.toLowerCase()] = true);
document.addEventListener("keyup", e=>keys[e.key.toLowerCase()] = false);

////////////////////////////
// アニメーション
////////////////////////////

function animate(){
 requestAnimationFrame(animate);

 let speed = 0.2;

 if(keys["w"]) ball.position.z -= speed;
 if(keys["s"]) ball.position.z += speed;
 if(keys["a"]) ball.position.x -= speed;
 if(keys["d"]) ball.position.x += speed;

 // カメラ追従
 camera.position.x = ball.position.x;
 camera.position.z = ball.position.z + 15;
 camera.lookAt(ball.position);

 ////////////////////////////
 // 吸収判定
 ////////////////////////////

 for(let i=objects.length-1;i>=0;i--){
  const obj = objects[i];

  const dist = ball.position.distanceTo(obj.position);

  if(dist < size + obj.userData.size){

   if(obj.userData.size < size*1.2){

    scene.remove(obj);
    objects.splice(i,1);

    size += obj.userData.size * 0.05;

    ball.scale.set(size,size,size);
    ball.position.y = size;

    document.getElementById("size").innerText = size.toFixed(1);
   }
  }
 }

 renderer.render(scene,camera);
}

animate();

</script>
</body>
</html>
