<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>HORROR CITY</title>
<style>
body { margin: 0; overflow: hidden; background: black; }
#info {
  position: absolute;
  top: 10px;
  left: 10px;
  color: white;
  font-family: sans-serif;
}
</style>
</head>
<body>
<div id="info">WASD移動 / マウス視点 / Fで振り向く</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>

<script>
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0a0a1a);

const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.y = 1.7;

const renderer = new THREE.WebGLRenderer();
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

const light = new THREE.AmbientLight(0x404040, 2);
scene.add(light);

const moon = new THREE.DirectionalLight(0x8888ff, 1);
moon.position.set(5,10,5);
scene.add(moon);

const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(200,200),
  new THREE.MeshStandardMaterial({color: 0x111111})
);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// ===== 建物 =====
const buildings = [];
for(let i=0;i<40;i++){
  const house = new THREE.Mesh(
    new THREE.BoxGeometry(3,4,3),
    new THREE.MeshStandardMaterial({color: 0x222244})
  );
  house.position.set(
    (Math.random()-0.5)*80,
    2,
    (Math.random()-0.5)*80
  );
  scene.add(house);
  buildings.push(house);
}

// ===== 敵 =====
const enemy = new THREE.Group();

// 下半身
const legs = new THREE.Mesh(
  new THREE.CylinderGeometry(0.5,0.5,2),
  new THREE.MeshStandardMaterial({color: 0x550000})
);
legs.position.y = 1;
enemy.add(legs);

// 胴体
const body = new THREE.Mesh(
  new THREE.BoxGeometry(1.5,2,1),
  new THREE.MeshStandardMaterial({color: 0x880000})
);
body.position.y = 3;
enemy.add(body);

// 頭
const head = new THREE.Mesh(
  new THREE.SphereGeometry(0.8),
  new THREE.MeshStandardMaterial({color: 0xaa0000})
);
head.position.y = 4.5;
enemy.add(head);

// 目
const eyeGeometry = new THREE.SphereGeometry(0.2);
const eyeMaterial = new THREE.MeshBasicMaterial({color: 0xffffff});
const eye1 = new THREE.Mesh(eyeGeometry, eyeMaterial);
eye1.position.set(-0.3,4.6,0.7);
enemy.add(eye1);

const eye2 = new THREE.Mesh(eyeGeometry, eyeMaterial);
eye2.position.set(0.3,4.6,0.7);
enemy.add(eye2);

enemy.position.set(10,0,10);
scene.add(enemy);

// ===== 操作 =====
const keys = {};
document.addEventListener("keydown", e=>{
  keys[e.key.toLowerCase()] = true;
  if(e.key.toLowerCase()==="f"){
    camera.rotation.y += Math.PI;
  }
});
document.addEventListener("keyup", e=> keys[e.key.toLowerCase()] = false);

// マウス視点
let pitch = 0;
let yaw = 0;

document.body.addEventListener("click",()=>{
  document.body.requestPointerLock();
});

document.addEventListener("mousemove", e=>{
  if(document.pointerLockElement === document.body){
    yaw -= e.movementX * 0.002;
    pitch -= e.movementY * 0.002;
    pitch = Math.max(-Math.PI/2, Math.min(Math.PI/2, pitch));
    camera.rotation.set(pitch, yaw, 0);
  }
});

function move(){
  const speed = 0.1;
  const dir = new THREE.Vector3();
  camera.getWorldDirection(dir);

  if(keys["w"]) camera.position.addScaledVector(dir, speed);
  if(keys["s"]) camera.position.addScaledVector(dir, -speed);

  const right = new THREE.Vector3();
  right.crossVectors(dir, camera.up);

  if(keys["a"]) camera.position.addScaledVector(right, -speed);
  if(keys["d"]) camera.position.addScaledVector(right, speed);
}

// 敵追跡
function updateEnemy(){
  const dx = camera.position.x - enemy.position.x;
  const dz = camera.position.z - enemy.position.z;
  const dist = Math.sqrt(dx*dx + dz*dz);

  if(dist > 1){
    enemy.position.x += dx/dist * 0.05;
    enemy.position.z += dz/dist * 0.05;
  }

  enemy.lookAt(camera.position);
}

function animate(){
  requestAnimationFrame(animate);
  move();
  updateEnemy();
  renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>
