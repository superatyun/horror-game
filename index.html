<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Midwest Escape 1998</title>
<style>
body{margin:0;overflow:hidden;background:black;}
#ui{
 position:absolute;top:10px;left:10px;
 color:white;font-family:sans-serif;
}
#staminaBar{
 width:200px;height:20px;background:#333;margin-top:5px;
}
#stamina{height:100%;width:100%;background:lime;}
</style>
</head>
<body>

<div id="ui">
WASD移動 / Shiftダッシュ / F振り向き
<div id="staminaBar"><div id="stamina"></div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script>

//////////////////////////////////////////////////
// シーン基本
//////////////////////////////////////////////////

const scene=new THREE.Scene();
scene.fog=new THREE.Fog(0xff9966,80,200); // 夕焼けフォグ

// スカイボックス（グラデーション）
const skyGeo=new THREE.SphereGeometry(500,32,32);
const skyMat=new THREE.ShaderMaterial({
 side:THREE.BackSide,
 uniforms:{
  topColor:{value:new THREE.Color(0xff9966)},
  bottomColor:{value:new THREE.Color(0x223366)},
 },
 vertexShader:`
  varying vec3 vWorldPosition;
  void main(){
    vec4 worldPosition=modelMatrix*vec4(position,1.0);
    vWorldPosition=worldPosition.xyz;
    gl_Position=projectionMatrix*modelViewMatrix*vec4(position,1.0);
  }
 `,
 fragmentShader:`
  uniform vec3 topColor;
  uniform vec3 bottomColor;
  varying vec3 vWorldPosition;
  void main(){
    float h=normalize(vWorldPosition).y;
    gl_FragColor=vec4(mix(bottomColor,topColor,max(h,0.0)),1.0);
  }
 `
});
scene.add(new THREE.Mesh(skyGeo,skyMat));

const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.1,1000);
camera.position.set(0,1.7,0);

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
renderer.shadowMap.enabled=true;
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff,0.7));
const sun=new THREE.DirectionalLight(0xffcc88,1);
sun.position.set(50,100,50);
scene.add(sun);

//////////////////////////////////////////////////
// 地面
//////////////////////////////////////////////////

const ground=new THREE.Mesh(
 new THREE.PlaneGeometry(400,400),
 new THREE.MeshStandardMaterial({color:0x444444})
);
ground.rotation.x=-Math.PI/2;
ground.receiveShadow=true;
scene.add(ground);

//////////////////////////////////////////////////
// 建物（窓ランダム発光）
//////////////////////////////////////////////////

function createHouse(x,z){

 if(Math.sqrt(x*x+z*z)<12) return;

 const house=new THREE.Group();

 const body=new THREE.Mesh(
   new THREE.BoxGeometry(4,3,4),
   new THREE.MeshStandardMaterial({color:0xd2b48c})
 );
 body.position.y=1.5;
 house.add(body);

 const roof=new THREE.Mesh(
   new THREE.ConeGeometry(3.5,2,4),
   new THREE.MeshStandardMaterial({color:0x8b0000})
 );
 roof.position.y=3.5;
 roof.rotation.y=Math.PI/4;
 house.add(roof);

 // ランダム点灯
 const lit=Math.random()>0.5;
 const windowMat=new THREE.MeshStandardMaterial({
   color:lit?0xffffaa:0x333333,
   emissive:lit?0xffcc66:0x000000
 });

 const windowGeo=new THREE.BoxGeometry(0.8,0.8,0.1);
 const w1=new THREE.Mesh(windowGeo,windowMat);
 w1.position.set(-1,1,2.05);
 house.add(w1);

 const w2=new THREE.Mesh(windowGeo,windowMat);
 w2.position.set(1,1,2.05);
 house.add(w2);

 house.position.set(x,0,z);
 scene.add(house);
}

for(let x=-60;x<=60;x+=10){
 for(let z=-60;z<=60;z+=10){
   if(Math.random()>0.2) createHouse(x,z);
 }
}

//////////////////////////////////////////////////
// 放置された車
//////////////////////////////////////////////////

function createCar(x,z){
 const car=new THREE.Group();

 const body=new THREE.Mesh(
   new THREE.BoxGeometry(3,1,2),
   new THREE.MeshStandardMaterial({color:0x222222})
 );
 body.position.y=0.5;
 car.add(body);

 const cabin=new THREE.Mesh(
   new THREE.BoxGeometry(1.5,1,1.8),
   new THREE.MeshStandardMaterial({color:0x444444})
 );
 cabin.position.set(0,1,0);
 car.add(cabin);

 car.position.set(x,0,z);
 scene.add(car);
}

for(let i=0;i<10;i++){
 createCar(
   (Math.random()-0.5)*120,
   (Math.random()-0.5)*120
 );
}

//////////////////////////////////////////////////
// 敵
//////////////////////////////////////////////////

const enemy=new THREE.Mesh(
 new THREE.BoxGeometry(2,5,2),
 new THREE.MeshStandardMaterial({color:0x880000})
);
enemy.position.set(-20,2.5,-20);
scene.add(enemy);

//////////////////////////////////////////////////
// カメラ最適化
//////////////////////////////////////////////////

let pitch=0,yaw=0,targetPitch=0,targetYaw=0;

document.addEventListener("mousemove",e=>{
 if(document.pointerLockElement===document.body){
   targetYaw-=e.movementX*0.001; // 感度さらに低下
   targetPitch-=e.movementY*0.001;
   targetPitch=Math.max(-Math.PI/4,Math.min(Math.PI/4,targetPitch)); // 可動域縮小
 }
});

document.body.addEventListener("click",()=>{
 document.body.requestPointerLock();
});

//////////////////////////////////////////////////
// 入力
//////////////////////////////////////////////////

const keys={};
document.addEventListener("keydown",e=>{
 const k=e.key.toLowerCase();
 keys[k]=true;
 if(k==="f") yaw+=Math.PI;
});
document.addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

//////////////////////////////////////////////////
// スタミナ
//////////////////////////////////////////////////

let stamina=100;
const staminaEl=document.getElementById("stamina");

//////////////////////////////////////////////////
// 移動
//////////////////////////////////////////////////

function move(){
 let speed=0.15;
 if(keys["shift"]&&stamina>0){
   speed=0.28;
   stamina-=0.6;
 }else stamina+=0.3;

 stamina=Math.max(0,Math.min(100,stamina));
 staminaEl.style.width=stamina+"%";
 staminaEl.style.background=stamina<30?"red":"lime";

 const dir=new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
 const right=new THREE.Vector3(-dir.z,0,dir.x);

 let moveVec=new THREE.Vector3();
 if(keys["w"]) moveVec.add(dir);
 if(keys["s"]) moveVec.sub(dir);
 if(keys["a"]) moveVec.sub(right);
 if(keys["d"]) moveVec.add(right);

 if(moveVec.length()>0){
   moveVec.normalize().multiplyScalar(speed);
   camera.position.x+=moveVec.x;
   camera.position.z+=moveVec.z;
 }

 camera.position.y=1.7;
}

//////////////////////////////////////////////////
// 敵追跡
//////////////////////////////////////////////////

function updateEnemy(){
 const dx=camera.position.x-enemy.position.x;
 const dz=camera.position.z-enemy.position.z;
 const dist=Math.sqrt(dx*dx+dz*dz);

 if(dist>2){
   enemy.position.x+=dx/dist*0.04;
   enemy.position.z+=dz/dist*0.04;
 }

 enemy.lookAt(camera.position);
}

//////////////////////////////////////////////////
// アニメーション
//////////////////////////////////////////////////

function animate(){
 requestAnimationFrame(animate);

 yaw+=(targetYaw-yaw)*0.1;   // 補間ゆるめ
 pitch+=(targetPitch-pitch)*0.1;
 camera.rotation.set(pitch,yaw,0);

 move();
 updateEnemy();

 renderer.render(scene,camera);
}
animate();

</script>
</body>
</html>
