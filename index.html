<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Katamari Web</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="menu">
    <h1>ステージ選択</h1>
    <button onclick="startGame('ie')">イエ</button>
    <button onclick="startGame('machi')">マチ</button>
    <button onclick="startGame('sekai')">セカイ</button>
    <button onclick="startGame('chikyu')">チキュウ</button>
    <button onclick="startGame('uchu')">ウチュウ</button>
  </div>

  <div id="ui"></div>

  <script type="module" src="main.js"></script>
</body>
</html>
body { margin:0; overflow:hidden; font-family:sans-serif; }
#menu {
  position:absolute;
  top:40%;
  width:100%;
  text-align:center;
  z-index:10;
}
button { padding:10px 20px; margin:5px; }
#ui {
  position:absolute;
  top:10px;
  left:10px;
  color:white;
  z-index:5;
}
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';
import { stages } from './stages.js';

let scene, camera, renderer, controls;
let ball, velocity = new THREE.Vector3();
let collected = [];
let currentRadius = 1;
let timeLeft = 120;
let goalSize = 5;
let stageData;

window.startGame = function(stageName){
  document.getElementById("menu").style.display="none";
  stageData = stages[stageName];
  init();
  animate();
}

function init(){
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87ceeb);

  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight,0.1,1000);
  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.shadowMap.enabled = true;
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  controls = new OrbitControls(camera, renderer.domElement);

  // Light
  const light = new THREE.DirectionalLight(0xffffff,1);
  light.position.set(10,20,10);
  light.castShadow=true;
  scene.add(light);

  const ambient = new THREE.AmbientLight(0xffffff,0.4);
  scene.add(ambient);

  // Ground
  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(200,200),
    new THREE.MeshStandardMaterial({color:0x55aa55})
  );
  ground.rotation.x=-Math.PI/2;
  ground.receiveShadow=true;
  scene.add(ground);

  // Ball
  currentRadius = stageData.initialSize;
  const ballGeo = new THREE.SphereGeometry(currentRadius,32,32);
  const ballMat = new THREE.MeshStandardMaterial({color:0xff66cc});
  ball = new THREE.Mesh(ballGeo,ballMat);
  ball.castShadow=true;
  ball.position.y=currentRadius;
  scene.add(ball);

  goalSize = stageData.goal;
  timeLeft = stageData.time;

  spawnObjects();
}

function spawnObjects(){
  stageData.objects.forEach(obj=>{
    const geo = new THREE.BoxGeometry(obj.size,obj.size,obj.size);
    const mat = new THREE.MeshStandardMaterial({color:obj.color});
    const mesh = new THREE.Mesh(geo,mat);
    mesh.position.set(
      (Math.random()-0.5)*50,
      obj.size/2,
      (Math.random()-0.5)*50
    );
    mesh.userData.size = obj.size;
    mesh.castShadow=true;
    scene.add(mesh);
  });
}

const keys = {};
window.addEventListener("keydown",e=>keys[e.key]=true);
window.addEventListener("keyup",e=>keys[e.key]=false);

function animate(){
  requestAnimationFrame(animate);

  let speed = keys["Shift"]?0.2:0.1;

  let dir = new THREE.Vector3();
  camera.getWorldDirection(dir);
  dir.y=0;
  dir.normalize();

  if(keys["w"]) velocity.add(dir.multiplyScalar(speed));
  if(keys["s"]) velocity.add(dir.multiplyScalar(-speed));

  ball.position.add(velocity);

  // 回転（動いてる時のみ）
  if(velocity.length()>0.01){
    ball.rotation.x += velocity.length();
  }

  velocity.multiplyScalar(0.95);

  checkCollisions();

  // カメラ距離調整
  controls.target.copy(ball.position);
  camera.position.set(
    ball.position.x + currentRadius*4,
    ball.position.y + currentRadius*2,
    ball.position.z + currentRadius*4
  );

  updateUI();

  renderer.render(scene,camera);
}

function checkCollisions(){
  scene.children.forEach(obj=>{
    if(obj.userData.size){
      const dist = ball.position.distanceTo(obj.position);
      if(dist < currentRadius + obj.userData.size/2){
        if(currentRadius >= obj.userData.size){
          ball.add(obj);
          collected.push(obj);
          currentRadius += obj.userData.size*0.05;
          ball.scale.setScalar(currentRadius/stageData.initialSize);
        }
      }
    }
  });
}

function updateUI(){
  timeLeft -= 1/60;
  document.getElementById("ui").innerHTML =
    `サイズ: ${currentRadius.toFixed(1)}m<br>
     目標: ${goalSize}m<br>
     残り時間: ${timeLeft.toFixed(0)}秒`;

  if(timeLeft<=0){
    alert(currentRadius>=goalSize?"成功！":"失敗！");
    location.reload();
  }
}
   export const stages = {
  ie:{
    initialSize:1,
    goal:5,
    time:120,
    objects:[
      {size:0.5,color:0xff0000},
      {size:0.8,color:0x0000ff},
      {size:1.5,color:0xffff00}
    ]
  },
  machi:{
    initialSize:3,
    goal:10,
    time:150,
    objects:[
      {size:2,color:0x333333},
      {size:1,color:0x00ff00},
      {size:4,color:0xff8800}
    ]
  },
  sekai:{ initialSize:5, goal:20, time:180, objects:[{size:3,color:0xffffff}]},
  chikyu:{ initialSize:10, goal:50, time:200, objects:[{size:5,color:0x999999}]},
  uchu:{ initialSize:20, goal:100, time:240, objects:[{size:10,color:0xaaaaaa}]}
}
