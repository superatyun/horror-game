<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Midwest Escape - Structured City</title>
<style>
body{margin:0;overflow:hidden;background:black;}
#ui{
position:absolute;top:10px;left:10px;
color:white;font-family:sans-serif;
}
</style>
</head>
<body>
<div id="ui">WASD移動 / Shiftダッシュ / F長押し振り向き</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.158/build/three.min.js"></script>
<script>

//////////////////////////////////////////////////
// 基本
//////////////////////////////////////////////////

const scene=new THREE.Scene();
scene.fog=new THREE.Fog(0x000000,20,120);

const camera=new THREE.PerspectiveCamera(70,innerWidth/innerHeight,0.1,1000);
camera.position.set(0,1.7,0);

const renderer=new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

//////////////////////////////////////////////////
// 光
//////////////////////////////////////////////////

const ambient=new THREE.AmbientLight(0x555555);
scene.add(ambient);

const moon=new THREE.DirectionalLight(0x99aaff,0.7);
moon.position.set(50,100,50);
scene.add(moon);

//////////////////////////////////////////////////
// 地面
//////////////////////////////////////////////////

const ground=new THREE.Mesh(
 new THREE.PlaneGeometry(400,400),
 new THREE.MeshStandardMaterial({color:0x2a2a2a})
);
ground.rotation.x=-Math.PI/2;
scene.add(ground);

//////////////////////////////////////////////////
// 衝突管理
//////////////////////////////////////////////////

const colliders=[];

function addCollider(mesh){
 const box=new THREE.Box3().setFromObject(mesh);
 colliders.push({mesh,box});
}

//////////////////////////////////////////////////
// 建物生成
//////////////////////////////////////////////////

function createHouse(x,z){
 const group=new THREE.Group();

 const base=new THREE.Mesh(
   new THREE.BoxGeometry(8,6,8),
   new THREE.MeshStandardMaterial({color:0x5a3a2a})
 );
 base.position.y=3;
 group.add(base);

 const roof=new THREE.Mesh(
   new THREE.ConeGeometry(6,4,4),
   new THREE.MeshStandardMaterial({color:0x222222})
 );
 roof.position.y=7;
 roof.rotation.y=Math.PI/4;
 group.add(roof);

 group.position.set(x,0,z);
 scene.add(group);

 addCollider(base);
}

function createBuilding(x,z){
 const height=20+Math.random()*30;

 const building=new THREE.Mesh(
   new THREE.BoxGeometry(12,height,12),
   new THREE.MeshStandardMaterial({color:0x333344})
 );
 building.position.set(x,height/2,z);
 scene.add(building);

 addCollider(building);
}

//////////////////////////////////////////////////
// エリア構造
//////////////////////////////////////////////////

// 住宅街（左側）
for(let x=-80;x<-10;x+=12){
 for(let z=-80;z<=80;z+=12){
   if(Math.abs(x)<15 && Math.abs(z)<15) continue;
   createHouse(x,z);
 }
}

// オフィス街（右側）
for(let x=20;x<=80;x+=20){
 for(let z=-80;z<=80;z+=20){
   createBuilding(x,z);
 }
}

//////////////////////////////////////////////////
// 敵
//////////////////////////////////////////////////

const enemyGroup=new THREE.Group();

const body=new THREE.Mesh(
 new THREE.CylinderGeometry(1.5,1.5,6,16),
 new THREE.MeshStandardMaterial({color:0x550000})
);
body.position.y=3;
enemyGroup.add(body);

const head=new THREE.Mesh(
 new THREE.SphereGeometry(1.5,16,16),
 new THREE.MeshStandardMaterial({color:0x331111})
);
head.position.y=6;
enemyGroup.add(head);

// 目
const eyeMat=new THREE.MeshBasicMaterial({color:0xffffff});
const eye1=new THREE.Mesh(new THREE.SphereGeometry(0.3,8,8),eyeMat);
eye1.position.set(0.5,6,1.2);
enemyGroup.add(eye1);

const eye2=eye1.clone();
eye2.position.x=-0.5;
enemyGroup.add(eye2);

enemyGroup.position.set(-30,0,-30);
scene.add(enemyGroup);

//////////////////////////////////////////////////
// 入力
//////////////////////////////////////////////////

const keys={};
let lookingBack=false;

document.addEventListener("keydown",e=>{
keys[e.key.toLowerCase()]=true;
if(e.key.toLowerCase()==="f") lookingBack=true;
});

document.addEventListener("keyup",e=>{
keys[e.key.toLowerCase()]=false;
if(e.key.toLowerCase()==="f") lookingBack=false;
});

//////////////////////////////////////////////////
// 衝突判定
//////////////////////////////////////////////////

function collide(pos){
 const playerBox=new THREE.Box3(
  new THREE.Vector3(pos.x-1,0,pos.z-1),
  new THREE.Vector3(pos.x+1,2,pos.z+1)
 );

 for(let c of colliders){
   if(playerBox.intersectsBox(c.box)) return true;
 }
 return false;
}

//////////////////////////////////////////////////
// ゲームオーバー処理
//////////////////////////////////////////////////

function resetGame(){
 camera.position.set(0,1.7,0);
 enemyGroup.position.set(-30,0,-30);
}

//////////////////////////////////////////////////
// アニメーション
//////////////////////////////////////////////////

let yaw=0;

function animate(){
 requestAnimationFrame(animate);

 let speed=keys["shift"]?0.3:0.15;

 let forward=new THREE.Vector3(Math.sin(yaw),0,Math.cos(yaw));
 let right=new THREE.Vector3(-forward.z,0,forward.x);

 let move=new THREE.Vector3();

 if(keys["w"]) move.add(forward);
 if(keys["s"]) move.sub(forward);
 if(keys["a"]) move.sub(right);
 if(keys["d"]) move.add(right);

 if(move.length()>0){
   move.normalize().multiplyScalar(speed);
   let newPos=camera.position.clone().add(move);
   if(!collide(newPos)){
     camera.position.x=newPos.x;
     camera.position.z=newPos.z;
   }
 }

 camera.position.y=1.7;

 // 敵追跡（障害物チェック付き）
 let dx=camera.position.x-enemyGroup.position.x;
 let dz=camera.position.z-enemyGroup.position.z;
 let dist=Math.sqrt(dx*dx+dz*dz);

 if(dist>2){
   let step=new THREE.Vector3(dx/dist*0.05,0,dz/dist*0.05);
   let next=enemyGroup.position.clone().add(step);
   if(!collide(next)){
     enemyGroup.position.copy(next);
   }
 }

 if(dist<2){
   alert("YOU WERE CAUGHT");
   resetGame();
 }

 enemyGroup.lookAt(camera.position);

 if(lookingBack){
   camera.rotation.y=yaw+Math.PI;
 }else{
   camera.rotation.y=yaw;
 }

 renderer.render(scene,camera);
}
animate();

</script>
</body>
</html>
